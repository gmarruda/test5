from fastapi import FastAPI, Request, Response
import requests

app = FastAPI()

# Azure TTS API configuration
TTS_ENDPOINT = "https://northeurope.tts.speech.microsoft.com/cognitiveservices/v1"
AZURE_TTS_KEY = "7ybJdwzvAbWw4tqnBp5UqFB4YiAr7gyq5QlzjAWv74HzufhR47PwJQQJ99BAACi5YpzXJ3w3AAAYACOGAyVi"  # Replace with your actual API key
HEADERS = {
    "Ocp-Apim-Subscription-Key": AZURE_TTS_KEY,
    "Content-Type": "application/ssml+xml",
    "X-Microsoft-OutputFormat": "riff-24khz-16bit-mono-pcm"
}

@app.post("/")
async def synthesize_speech(request: Request):
    """Receives text from the user, calls Azure TTS, and returns the audio file."""
    try:
        data = await request.json()
        text = data.get("text", "").strip()

        if not text:
            return {"error": "No text provided"}

        # Construct SSML body for Azure TTS
        ssml_body = f"""
        <speak version='1.0' xml:lang='pt-BR'>
            <voice xml:lang='pt-BR' xml:gender='Female' name='pt-BR-LeilaNeural'>
                {text}
            </voice>
        </speak>
        """

        # Send request to Azure TTS API
        tts_response = requests.post(TTS_ENDPOINT, data=ssml_body, headers=HEADERS)

        if tts_response.status_code != 200:
            return {"error": f"Azure TTS API failed with status {tts_response.status_code}"}

        # Return the audio response with correct Content-Type
        return Response(content=tts_response.content, media_type="audio/x-wav")

    except Exception as e:
        return {"error": str(e)}

# Run the FastAPI app
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
